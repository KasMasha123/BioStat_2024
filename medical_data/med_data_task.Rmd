---
title: "Особенности медицинских данных"
author: "Касьянова Мария"
date: "2024-10-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, error = FALSE)

library(tidyverse)
library(rstatix)
library(pROC)
library(readxl)

```

## Загрузка данных

Предварительный просмотр таблицы в exсel показал, что:

* при записи роста использовалось не число, а строка с дополнительными символами
* в графе Hb встречалось значение 0, хотя гемоглобин не может отсутсвовать в крови живого человека, так что скорее всего эту запись использовали, когда тест вообще не проводился, то есть корректное значение в строках с 0 - это NA
* смерть обозначалась числами 0 или 1, данную колонку необходимо сделать фактором, так как это не количественная переменная
* пол тоже должен быть фактором
* можно перевести рост в м, а вес в кг, чтобы было легче интерпретировать данные

Исправим все перечисленное

```{r}
trauma_data <- read_excel("trauma.xlsx")

trauma_data<- trauma_data %>%
  mutate(Height = as.numeric(str_remove(Height, '"'))*2.54/100,
         Weight = Weight/2.2,
         across(c(id, Death, Sex), ~ as.factor(.x)),
         Hb = na_if(Hb, 0))
```

Теперь таблица выглядит правильно, что подстверждают описательные статистики для всех переменных:
```{r}
trauma_data %>% summary()
```

Доболнительно узнаем, у какого количества и процента пациентов был снижен гемоглобин, используя следующие референтные значения: 

* Мужчины: 13.5–16 г/дл
* Женщины: 12–14 г/дл

```{r}
small_hb_count<- trauma_data %>%
  subset((Sex == "Female" & Hb <12)|(Sex == "Male" & Hb < 13.5))%>%
  nrow()


print(str_c("Количество людей со сниженным гемоглобином равно ", small_hb_count, "."))
print(str_c("Это ", sprintf("%.1f", small_hb_count/nrow(trauma_data)*100), "%."))
```
## Ожирение

Добавим колонку с индексом массы тела у пациентов (кг / м2). 

```{r}
trauma_data <- trauma_data %>%
  mutate(BMI = (Weight / Height / Height)%>% round(1))

mean_BMI <- mean(trauma_data$BMI)%>% round(1)
SD_BMI <- sd(trauma_data$BMI)%>% round(1)

print(str_c("Средний индекс массы тела (М) -  ", mean_BMI, "кг/м2, стандартное отклонение (SD) равно ", SD_BMI, "."))
```


```{r}
big_BMI_count<- trauma_data %>%
  subset(BMI >30)%>%
  nrow()

print(str_c("Доля пациентов с ожирением составила ", round(big_BMI_count/nrow(trauma_data)*100, 1), "%."))
```

# Анализ ROC-кривых

Проведём ROC-анализ для предсказания летального исхода по
переменной, характеризующей уровень гемоглобина:

```{r}
roc_curve_1 <- roc(Death ~ Hb, 
                   data = trauma_data,
                   ci = T)
roc_curve_1 %>% 
    ggroc() + 
    theme_bw()
```

Эта ROC кривая явно выше диагонали, но имеет не совсем обычно изогнутую форму (недостаточно выпуклую, в середине похожа на прямую, а по краям резкие перепады). Скорее всего это связано с тем, что экстремальные значения гемоглобина ассоциированны со смертностью сильнее, чем средние (грубо говоря, все, у кого гемоглобин очень маленький, умирали, а у кого очень большой - выживали, в то время как люди со средним гемоглобином не имели четкой закономерности в выживаемости).


```{r, fig.height=3, fig.width=3}
roc_curve_1
```
Площадь под кривой составляет 0.7078 (95% двусторонний доверительный интервал: 0.6763-0.7392)

# Предсказание по шкале комы Глазго

Проведем аналогичные рассчеты для предсказания сметрности по шкале Глазго
```{r}
roc_curve_2 <- roc(Death ~ GSC, 
                   data = trauma_data,
                   ci = T)

roc_curve_2 %>% 
    ggroc() + 
    theme_bw()
```

```{r, fig.height=3, fig.width=3}
roc_curve_2 
```
На этот раз площадь под кривой равна 0.9124 (ДИ: 0.8959-0.9289). Можно выбрать оптимальный порог для предсказания: он сотавил 7.5, при нем специфичность равна 0.81, а чувствительность - 0.86.

```{r}
roc_curve_2 %>% coords(x = "best", best.method = "closest.topleft")
```

## Что лучше использовать для предсказания?

Протестируем все количественные переменные по предсказательной силе: 
```{r}
trauma_data %>% 
    select("Death",
           "Age",
           "Height",
           "Weight",
           "BMI",
           "SBP",
           "DBP",
           "FOUR",
           "GSC",
           "Hb") %>% 
    pivot_longer(cols = !Death, names_to = "name") %>% 
    group_by(name) %>% 
    summarise(AUC = roc(Death, value, ci = T)$ci[2] %>% round(3),
              AUC_LCL = roc(Death, value, ci = T)$ci[1] %>% round(3),
              AUC_UCL = roc(Death, value, ci = T)$ci[3] %>% round(3))%>%
  arrange(AUC)
```

Наибольшей площадью под ROC кривой обладает переменная шкалы комы FOUR, за ней идет шкала Глазго. То есть с наибольшей вероятностью предсказать смерть в течение 24 часов после поступления позволят эти две шкалы (лучше использовать FOUR). Также на предсказание может повлиять значение систолического и диастолического артериального давления и уровень гемоглобина, остальные переменные предсказательной силой не обладают (доверительный интервал захватывает 0.5). Наименьшую площадь под кривой имеет рост.

