---
title: "Домашнее задание по использованию классических статистических тестов"
author: "Касьянова Мария"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
```



# Гипотеза 1. Существует ассоциация между уровнем физической активности (бинарная переменная, физическая активность может быть 'высокой' и 'низкой') и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет. Попробуйте вариант с большими выборками (sample_size <- 100). Как изменится стратегия при малых выборках (sample_size <- 30)? 

## Генерация данных, случай большой выборки

```{r}
# Воспроизводимость результатов
set.seed(45)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- c(rep(1, sample_size/2), rep(0, sample_size/2)) 

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- c(rbinom(sample_size/2, size = 1, prob = 0.5), rbinom(sample_size/2, size = 1, prob = 0.6))
```

## Решение

1. Статистические гипотезы:

* H0: физическая активность и наличие сердечно-сосудистых заболеваний не ассоциированы
* HA: физическая активность и наличие сердечно-сосудистых заболеваний ассоциированы
  
2. Уровень значимости (α) равняется 0.05
3. Для проверки гипотезы будем использовать тест ассоциации Хи2
4. Критическое значение статистики равно:
```{r}
qchisq(p = 0.95, df = 1)
```
5. Наблюдаемое значение статистики равно: 

```{r}
# Создание таблицы сопряженности (замените своими данными)
m <- table(data.frame(activity = activity, cardio = cardio))
rownames(m) <- c("нет", "да")
colnames(m) <- c("нет", "да")

# Проведение теста хи-квадрат для ассоциации
chi_result <- chisq.test(m, correct = F)
chi_result$statistic
```
6. Поскольку наблюдаемое значение статистики меньше критического, нулевая (статистическая) гипотеза в данном случае не отвергается:

```{r}
# Загрузка необходимых библиотек
library(ggplot2)

# Расчет наблюдаемого значения хи-квадрат (замените на ваше фактическое наблюдаемое значение)
observed_chi_squared <- chi_result$statistic  # Замените на ваше реальное наблюдаемое значение

# Определение степеней свободы для распределения хи-квадрат
df <- 1  # Подстраивайте степени свободы по мере необходимости

# Создание последовательности значений x
x_values <- seq(0.01, 10, by = 0.01)  # Подстраивайте диапазон и шаг по мере необходимости

# Расчет значений PDF для распределения хи-квадрат
pdf_chi_squared <- dchisq(x_values, df)

# Квантили
quantiles <- c(0, 0.95)

# Расчет критических значений для распределения хи-квадрат
critical_value_lower <- qchisq(quantiles[1], df)
critical_value_upper <- qchisq(quantiles[2], df)



# Создание data frame для построения графика
pdf_data <- data.frame(x = x_values, Probability = pdf_chi_squared)

# Создание графика PDF для визуализации распределения хи-квадрат
ggplot(pdf_data, aes(x = x, y = Probability)) +
  geom_line(size = 1, color = "black") +
  labs(title = "PDF распределения хи-квадрат", x = "x", y = "Плотность вероятности") +
  theme_minimal() +
  geom_vline(xintercept = c(critical_value_lower, critical_value_upper, observed_chi_squared),
             linetype = c("solid", "solid", "dashed"),
             color = c("blue", "blue", "red"),
             size = c(2, 2, 2)) +
  annotate("text", x = critical_value_lower - 0.5, y = 0.1, label = sprintf("Q(%.3f)=%.2f", quantiles[1], critical_value_lower), hjust = 0, angle = 90) +
  annotate("text", x = critical_value_upper - 0.5, y = 0.1, label = sprintf("Q(%.3f)=%.2f", quantiles[2], critical_value_upper), hjust = 0, angle = 90) +
  annotate("text", x = observed_chi_squared - 0.5, y = 0.1, label = 'наблюдаемое', hjust = 0, angle = 90) +
  annotate("text", x = critical_value_upper - 1, y = 0.5, label = sprintf("df = %.0f", df), hjust = 0)
```

7. Клиническия гипотеза не подтверждается (ассоциация не найдена). Зная, как мы генерировали данные, можно понять, что на самом деле ассоциация есть, однако мощность нашего теста небольшая, так что мы совершаем ошибку II рода.

## Генерация данных, случай маленькой выборки

```{r}
# Воспроизводимость результатов
set.seed(45)

# Общий размер выборки
sample_size <- 30

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- c(rep(1, sample_size/2), rep(0, sample_size/2)) 

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- c(rbinom(sample_size/2, size = 1, prob = 0.5), rbinom(sample_size/2, size = 1, prob = 0.6))

m <- table(data.frame(activity = activity, cardio = cardio))
print(m)
```

## Решение


1. Статистические гипотезы:

* H0: физическая активность и наличие сердечно-чочудичтый заболеваний не ассоциированы
* HA: физическая активность и наличие сердечно-чочудичтый заболеваний ассоциированы
  
2. Уровень значимости (α) равняется 0.05
3. В данном случае использование обычного теста Хи2 осножняется тем, что появляются маленькие значения (<5) и их больше 20% (так как у нас таблица 2х2 всего одно такое значение уже препятсвует использованию обычного теста). Поэтому, для проверки гипотезы мы будем использовать тест ассоциации Хи2 с Монте-Карло (также подошел бы точный тест фишера).

4. Критическое значение статистики в данном случае будет взято не из самого распределения Хи2: программа сгенерирует большое количество таблиц, имеющих такую же сумму по столбцам и по строкам, как рассматриваемая таблица, и проверит, в каком проценте случаев статистика будет больше либо равна исходной, отсюда же рассчитывается p-value

5. Наблюдаемое значение статистики равно 

```{r}
# Проведение теста хи-квадрат для ассоциации
chi_result <- chisq.test(m, simulate.p.value = TRUE, B = 10000)

chi_result
```
6. Статистическая (нулевая) гипотеза не отвергается, так как p-value больше 0.05

7. Клиническия гипотеза опять не подтверждается.

# Гипотеза 2. Применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение.


## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки (в каждой группе)
sample_size <- 80

# В популяции c экспериментальным методом лечения средний уровень систолического артериального давления меньше (130 vs 135 mm) 
# Генерация данных для группы с новым методом лечения 
group1 <- rnorm(sample_size, 130, 10)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(sample_size, 135, 8)  # контрольная группа

```

## Решение

1. Статистические гипотезы:

* H0: m1 = m2
* HA: m1 < m2
  
Где m1 – среднее артериальное давление в популяции с экспериментальным методом лечения, m2  – среднее артериальное давление в популяции со стандартным методом лечения.

2. Уровень значимости (α) равняется 0.05
3. Для проверки гипотезы будем использовать односторонний тест Стьюдента для независимых выборок с поправкой Уэлча (с предположением о неравных дисперсиях)
4. Критическое значение статистики равно 
```{r}
qt(p = 0.05, df = 158)
```

5. Наблюдаемое значение статистики равно 
```{r}
t_result <- t.test(group1, group2, var.equal = F, alternative = "less")
t_result$statistic
```

6. Нулевая (статистическая) гипотеза отвергается

```{r}

# Загрузка необходимого пакета ggplot2
library(ggplot2)

#?quantile

observed=t_result$statistic

# Define the degrees of freedom for the t-distribution
df <- 79  # Degrees of freedom

# Create a sequence of x values
x_values <- seq(-4, 4, by = 0.01)  # Adjust the range and step size as needed

# Calculate the PDF values for the t-distribution
pdf_t <- dt(x_values, df)

# Квантили
quantiles <- c(0.05, 1)

#quantile_values <- qnorm(quantiles, mean = 0, sd = 1)

t_critical_low <- qt(quantiles[1], df = df)
t_critical_up <-  qt(quantiles[2], df = df)

# Create a data frame for plotting
pdf_data <- data.frame(x = x_values, Probability = pdf_t)

# Создание графика PDF для визуализации стандартного нормального распределения
ggplot(pdf_data, aes(x = x)) +
  geom_line(aes(y = Probability), linewidth = 1, color = "black", linetype = "solid") +
  geom_vline(xintercept = t_critical_low, linewidth = 2, linetype = "solid", color = "blue") +
  geom_vline(xintercept = t_critical_up, linewidth = 2, linetype = "solid", color = "blue") +
  geom_vline(xintercept = observed, linewidth = 2, linetype = "dashed", color = "red") +
  annotate("text", x = t_critical_low-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[1], t_critical_low), hjust = 0, angle = 90) +
  annotate("text", x = t_critical_up-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[2], t_critical_up), hjust = 0, angle = 90) +
  annotate("text", x = observed-0.15, y = 0.2, label = 'observed', hjust = 0, angle = 90)+
  annotate("text", x = 2.5, y = 0.4, label = sprintf("df(%.0f)", df), hjust = 0)+
  labs(title = "PDF распределения Стьюдента", x = "x", y = "Плотность вероятности")


```

7. С одной стороны можно сказать, что клиническая гипотеза подтвердилась, ведь среднее артериальное давление в экспериментальной группе и правда меньше. Однако разница в средних составила всего 4 мм рт. ст. (в обеих группах значение находится около верхней границы нормы). Мне кажется, что клиническая значимость будет зависеть от целей и задач исследователя. Если новое лечение сильно дороже или неудобней в использовании, то 4 мм могут быть недостаточно весомыми. Если же оно имеет другие преимущества, то снижение, хоть и небольшое, можно считать плюсом.

# Гипотеза 3. Внедрение программы реабилитации для пациентов с хронической болью в спине приведет к улучшению их физической активности (предположим что физическую активность можно оценить по шкале 0-100)

## Генерация данных 

```{r}
# Воспроизводимость результатов
set.seed(42)

# Размер выборки 
sample_size <- 30

# В популяции до реабилитации средний уровень физической активности меньше (50 vs 60) 
# Генерация данных до реабилитации
before <- rbinom(sample_size, size = 100, prob = 0.5)

# Генерация данных после реабилитации
after <- rbinom(sample_size, size = 100, prob = 0.6)  

mean(before)
mean(after)
```

## Решение

1. Статистические гипотезы:

* H0: m1 = m2
* HA: m1 != m2,

Где m1 - средняя физическая активность людей до реабилитации, а m2 - после
  
2. Уровень значимости (α) равняется 0.05
3. Для проверки гипотезы будем использовать тест Стюдента для зависимых выборок (предполагается, что физическая активность измерялась дважды у одного пациента - до реабилитации и после). 
4. Критическое значение статистики равно:
```{r}
qt(p = 0.025, df = 29)
```
5. Наблюдаемое значение статистики равно:
```{r}
t_result <- t.test(before, after, paired = T)
t_result$statistic
```

6. Нулевая (статистическая) гипотеза о равенсте средних отвергается:
```{r}

# Загрузка необходимого пакета ggplot2
library(ggplot2)

#?quantile

observed=t_result$statistic

# Define the degrees of freedom for the t-distribution
df <- 29  # Degrees of freedom

# Create a sequence of x values
x_values <- seq(-8, 8, by = 0.01)  # Adjust the range and step size as needed

# Calculate the PDF values for the t-distribution
pdf_t <- dt(x_values, df)

# Квантили
quantiles <- c(0.025, 0.975)

#quantile_values <- qnorm(quantiles, mean = 0, sd = 1)

t_critical_low <- qt(quantiles[1], df = df)
t_critical_up <-  qt(quantiles[2], df = df)

# Create a data frame for plotting
pdf_data <- data.frame(x = x_values, Probability = pdf_t)

# Создание графика PDF для визуализации стандартного нормального распределения
ggplot(pdf_data, aes(x = x)) +
  geom_line(aes(y = Probability), linewidth = 1, color = "black", linetype = "solid") +
  geom_vline(xintercept = t_critical_low, linewidth = 2, linetype = "solid", color = "blue") +
  geom_vline(xintercept = t_critical_up, linewidth = 2, linetype = "solid", color = "blue") +
  geom_vline(xintercept = observed, linewidth = 2, linetype = "dashed", color = "red") +
  annotate("text", x = t_critical_low-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[1], t_critical_low), hjust = 0, angle = 90) +
  annotate("text", x = t_critical_up-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[2], t_critical_up), hjust = 0, angle = 90) +
  annotate("text", x = observed-0.15, y = 0.2, label = 'observed', hjust = 0, angle = 90)+
  annotate("text", x = 2.5, y = 0.4, label = sprintf("df(%.0f)", df), hjust = 0)+
  labs(title = "PDF распределения Стьюдента", x = "x", y = "Плотность вероятности")


```

7. Клиническая гипотеза подтвердилась: физическая активность у пациентов улучшается примерно на 10 баллов после прохождения реабилитации (доверительный интервал: [-13.2; -7.5]). Для 100 бальной шкалы это должно быть достаточно значимым результатом.

```{r}
t_result
```


# Гипотеза 4. Применение нового метода лечения для пациентов с инфарктом миокарда увеличит долю вернувшихся к нормальной физической активности 

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 200

# В популяции экспериментального лечения вероятность нормальной физической активности больше (0.7 vs 0.65)
# Генерация данных по статусу лечение (бинарная переменная, новый метод или стандарт) в фиксированном соотношении 1:1
treatment <- c(rep(1, sample_size/2), rep(0, sample_size/2))

# Генерация данных по физической активности после лечения (бинарная переменная)
activity <-  c(rbinom(sample_size/2, size = 1, prob = 0.7), rbinom(sample_size/2, size = 1, prob = 0.65))

table(data.frame(treatment = treatment, activity = activity))
```

## Решение

1. Статистические гипотезы:

* H0: p1 = p2
* HA: p1 > p2
  
Где p1 – доля возвращающихся к нормальной физической активности после экспериментального лечения, p2 – доля возвращающихся к нормальной физической активности после стандартного лечения.

2. Уровень значимости (α) равняется 0.05
3. Для проверки гипотезы будем использовать асимптотический Z тест разности долей в независимых выборках 
4. Критическое значение статистики равно 
```{r}
qnorm(0.025, mean = 0, sd = 1)
```

5. Наблюдаемое значение статистики равно 

```{r}
# Функция для проведения z-теста для двух независимых долей
performTwoProportionZTest <- function(n1, x, n2, y) {
  # Расчет долей успешных исходов в выборках
  p1 <- x / n1
  p2 <- y / n2

  # Расчет объединенной доли успешных исходов
  P <- (x + y) / (n1 + n2)

  # Расчет стандартной ошибки
  SQ <- P * (1 - P) * (1/n1 + 1/n2)

  # Выполнение z-теста
  z_test_result <- (p1 - p2) / sqrt(SQ)

  return(z_test_result)
}

# Использование функции:
n1 <- 100  # Общее количество попыток для выборки 1
x <- 61  # Количество успешных исходов для выборки 1

n2 <- 100  # Общее количество попыток для выборки 2
y <- 66   # Количество успешных исходов для выборки 2

z_test_result <- performTwoProportionZTest(n1, x, n2, y)
print(z_test_result)
```

6. Статистическая гипотеза не отвергается
```{r}

# Загрузка необходимого пакета ggplot2
library(ggplot2)

#?quantile

observed= z_test_result

# Создание последовательности значений x
x_values <- seq(-4, 4, by = 0.01)

# Расчет значений Плотности Вероятности (PDF) для стандартного нормального распределения
pdf_normal <- dnorm(x_values, mean = 0, sd = 1)

# Квантили
quantiles <- c(0.025, 0.975)

quantile_values <- qnorm(quantiles, mean = 0, sd = 1)

# Создание данных для построения графика
pdf_data <- data.frame(x = x_values, Probability = pdf_normal)

# Создание графика PDF для визуализации стандартного нормального распределения
ggplot(pdf_data, aes(x = x)) +
  geom_line(aes(y = Probability), linewidth = 1, color = "black", linetype = "solid") +
  geom_vline(xintercept = quantile_values, linewidth = 2, linetype = "solid", color = "blue") +
  geom_vline(xintercept = observed, linewidth = 2, linetype = "dashed", color = "red") +
  annotate("text", x = quantile_values[1]-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[1], quantile_values[1]), hjust = 0, angle = 90) +
  annotate("text", x = quantile_values[2]-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[2], quantile_values[2]), hjust = 0, angle = 90) +
  annotate("text", x = observed-0.15, y = 0.2, label = 'observed', hjust = 0, angle = 90)+
  labs(title = "PDF стандартного нормального распределения", x = "x", y = "Плотность вероятности")

```

7. Клиническия гипотеза не подтверждается

# Гипотеза 5. Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности.

## Генерация данных 

```{r}
# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 50

# Генерация данных до медитации (бинарная переменная)
before <- rbinom(sample_size, size = 1, prob = 0.4)

# Генерация данных после медитации (бинарная переменная). После медитации вероятность наличия стресса меньше (0.2 vs 0.4)
after <- rbinom(sample_size, size = 1, prob = 0.2)

m <- table(data.frame(before = before, after = after))
print(m)
```

## Решение

1. Статистические гипотезы:

* H0: вероятность наличия стресса до медитации равна вероятности наличия стресса после медитации
* HA: вероятность наличия стресса до медитации не равна вероятности наличия стресса после медитации
  
2. Уровень значимости (α) равняется 0.05
3. Для проверки гипотезы будем использовать тест Мак-Немара для связанных выборок
4. Критическое значение статистики равно:
```{r}
qchisq(p = 0.95, df = 1)
```

5. Наблюдаемое значение статистики равно:
```{r}
mcnemar.test(m)
```

6. Статистическая нулевая гипотеза отвергается (p-value меньше 0.05) 
7. Клиническая гипотеза подтвердилась, после медитации количество пациентов со стрессом уменьшилось с 28 до 5 из 50. Такой результат можно назвать значимым не только со статистической, но и с клинической точки зрения.

# Гипотеза 6. Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение (депрессию можно определить по шкале от 0 до 100, при этом исследователь должен избегать любых предположений (кроме i.i.d.)).

## Генерация данных 
```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20


# В популяции c экспериментальным методом лечения среднее депрессии меньше (55 vs 68) 
# Генерация данных для экспериментальной группы 
group1 <- rbinom(sample_size, size = 100, prob = 0.55) # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rbinom(sample_size, size = 100, prob = 0.68) # контрольная группа
```

## Решение

1. Статистические гипотезы:

* H0: m1 = m2
* HA: m1 != m2,

Где m1 - средний уровень симптомов депрессии в группе с экспериментальным лечением, а m2 - в группе со стандартным лечением
  
2. Уровень значимости (α) равняется 0.05
3. Так как нам нельзя строить никаких предположений о распределении и размер выборки невелик, для проверки данной гипотезы мы будем использовать непараметрический тест Манна-Уитни-Уилкоксона
4. Критическое значение статистики равно 127 (http://www.machinelearning.ru/wiki/images/9/92/Critical_Values_for_the_Mann-Whitney_U-Test_p5_1.pdf)
5. Наблюдаемое значение статистики равно:
```{r}
wilcox.test(group2, group1)
```
6. Нулевая статистическая uипотеза отвергается, так как наблюдаемое значение статистики больше критического 
7. Клиническая гипотеза подтвердилась, средние значения депрессии различаются на 12.85 баллов между двумя группами (54.5 vs 67.35).

# Гипотеза 7. Длительность сна (в часах) ассоциирована с уровенем стресса у студентов (шкала с нормальным распределением)

## Генерация данных  

```{r}
library(mvtnorm) # библиотека mvtnorm для работы с многомерным нормальным распределением

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7, 5)  

# Матрица ковариации. В ислледуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
cov_matrix <- matrix(c(1, -0.5, -0.5, 1), nrow = 2)

df <- rmvnorm(n = sample_size, 
              mean = means, 
              sigma = cov_matrix) %>% 
      as_tibble() %>%
      setNames(c("HoursOfSleep", "StressLevel"))  

```
## Решение (дополните решение визуализацией)

0. Визуализация:
```{r}
df%>%
  ggplot(aes(x = HoursOfSleep, y = StressLevel))+
  geom_point()+
  theme_bw()+
  geom_smooth(method = "lm")
```

1. Статистические гипотезы:

* H0: коэффициент корреляции Пирсона между длительностью сна и уровнем стресса равен 0
* HA: коэффициент корреляции Пирсона между длительностью сна и уровнем стресса не равен 0
  
2. Уровень значимости (α) равняется 0.05
3. Для проверки гипотезы будем пользоваться критерием корреляции Пирсона
5. Наблюдаемое значение статистики равно:
```{r}
cor.test(df$HoursOfSleep, df$StressLevel)
```

6. Нулевая (статистическая) гипотеза отвергаетсятак, так как p-value меньше 0.05 и доверительный интервал не включает в себя 0
7. Клиническая гипотеза подтверждается, коэффициент корреляции равен -0.52, что говорит о заметной взаимосвязи переменных (ассоциация не самая сильная, но клинически значимая)




